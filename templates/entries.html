{% extends "base.html" %}
{% import "macros.html" as macros %}

{% block title %}Entries - RDRS{% endblock %}

{% block flash %}{% call macros::flash(flash_messages) %}{% endblock %}

{% block content %}
{% call macros::nav("entries", is_admin, is_masquerading, username) %}

<h1>Entries</h1>

<div style="display:flex; gap:2rem; flex-wrap:wrap; align-items:flex-end; margin-bottom:1rem;">
    <div class="form-group" style="margin-bottom:0;">
        <label for="filter-feed">Feed</label>
        <select id="filter-feed" onchange="handleFilterChange()">
            <option value="">All Feeds</option>
        </select>
    </div>
    <div class="form-group" style="margin-bottom:0;">
        <label for="filter-category">Category</label>
        <select id="filter-category" onchange="handleFilterChange()">
            <option value="">All Categories</option>
        </select>
    </div>
    <div class="form-group" style="margin-bottom:0;">
        <label>
            <input type="checkbox" id="filter-unread" onchange="handleFilterChange()"> Unread only
        </label>
    </div>
    <div class="form-group" style="margin-bottom:0;">
        <label>
            <input type="checkbox" id="filter-starred" onchange="handleFilterChange()"> Starred only
        </label>
    </div>
    <div class="form-group" style="margin-bottom:0;">
        <label for="mark-read-age">Mark as Read</label>
        <select id="mark-read-age" onchange="markAsRead(this.value); this.selectedIndex=0;">
            <option value="">Select...</option>
            <option value="1">Older than 1 day</option>
            <option value="7">Older than 1 week</option>
            <option value="30">Older than 1 month</option>
            <option value="365">Older than 1 year</option>
            <option value="all">All entries</option>
        </select>
    </div>
    <div>
        <button type="button" onclick="loadEntries()">[Refresh]</button>
    </div>
</div>

<hr>

<div id="entries-list">
    <p class="muted">Loading...</p>
</div>

<div id="load-more" style="display:none; margin-top:1rem;">
    <button type="button" onclick="loadMore()">[Load More]</button>
</div>

<p id="entries-count" class="muted"></p>

<script>
    let entries = [];
    let categories = [];
    let feeds = [];
    let currentOffset = 0;
    const limit = 50;
    let total = 0;

    async function loadCategories() {
        try {
            const response = await fetch('/api/categories');
            if (!response.ok) throw new Error('Failed to load categories');
            categories = await response.json();
            updateCategoryDropdown();
        } catch (err) {
            console.error(err);
        }
    }

    async function loadFeeds() {
        try {
            const response = await fetch('/api/feeds');
            if (!response.ok) throw new Error('Failed to load feeds');
            feeds = await response.json();
            updateFeedDropdown();
        } catch (err) {
            console.error(err);
        }
    }

    function updateCategoryDropdown() {
        const select = document.getElementById('filter-category');
        const currentValue = select.value;
        select.innerHTML = '<option value="">All Categories</option>' +
            categories.map(cat => `<option value="${cat.id}">${escapeHtml(cat.name)}</option>`).join('');
        select.value = currentValue;
    }

    function updateFeedDropdown() {
        const select = document.getElementById('filter-feed');
        const currentValue = select.value;
        select.innerHTML = '<option value="">All Feeds</option>' +
            feeds.map(f => `<option value="${f.id}">${escapeHtml(f.title || f.url)}</option>`).join('');
        select.value = currentValue;
    }

    async function loadEntries(reset = true) {
        if (reset) {
            currentOffset = 0;
            entries = [];
        }

        const feedId = document.getElementById('filter-feed').value;
        const categoryId = document.getElementById('filter-category').value;
        const unreadOnly = document.getElementById('filter-unread').checked;
        const starredOnly = document.getElementById('filter-starred').checked;

        let url = `/api/entries?limit=${limit}&offset=${currentOffset}`;
        if (feedId) url += `&feed_id=${feedId}`;
        if (categoryId) url += `&category_id=${categoryId}`;
        if (unreadOnly) url += `&unread_only=true`;
        if (starredOnly) url += `&starred_only=true`;

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error('Failed to load entries');
            }
            const data = await response.json();

            if (reset) {
                entries = data.entries;
            } else {
                entries = entries.concat(data.entries);
            }
            total = data.total;

            renderEntries();
            updateLoadMoreButton();
            updateEntriesCount();
        } catch (err) {
            document.getElementById('entries-list').innerHTML = '<p class="muted">[ERROR] Failed to load entries</p>';
        }
    }

    function renderEntries() {
        const container = document.getElementById('entries-list');

        if (entries.length === 0) {
            container.innerHTML = '<p class="muted">No entries found.</p>';
            return;
        }

        container.innerHTML = entries.map(entry => {
            const title = entry.title || 'Untitled';
            const feedTitle = entry.feed_title || entry.feed_url;
            const date = entry.published_at ? formatDate(entry.published_at) : '';
            const dateTitle = entry.published_at ? formatDateTime(entry.published_at) : '';
            const isRead = entry.read_at !== null;
            const isStarred = entry.starred_at !== null;
            const feedIconHtml = entry.feed_has_icon
                ? `<img src="/api/feeds/${entry.feed_id}/icon" alt="" class="feed-icon" onerror="this.style.display='none'">`
                : '';

            return `
            <div class="entry-item" id="entry-${entry.id}" style="margin-bottom:1rem; padding-bottom:1rem; border-bottom:1px solid #ccc; ${isRead ? 'opacity:0.6;' : ''}">
                <div>
                    <a href="/entries/${entry.id}" style="font-weight:${isRead ? 'normal' : 'bold'};">${escapeHtml(title)}</a>
                    ${isStarred ? '<span title="Starred">*</span>' : ''}
                </div>
                <div class="muted" style="font-size:0.875rem;">
                    ${feedIconHtml}<a href="#" data-feed-id="${entry.feed_id}" data-feed-category-id="${entry.category_id}">${escapeHtml(feedTitle)}</a> &middot; <a href="#" data-category-id="${entry.category_id}">${escapeHtml(entry.category_name)}</a>${date ? ` &middot; <span title="${dateTitle}">${date}</span>` : ''}
                </div>
                <div style="margin-top:0.5rem;">
                    ${isRead
                        ? `<a href="#" onclick="markUnread(${entry.id}); return false;">[unread]</a>`
                        : `<a href="#" onclick="markRead(${entry.id}); return false;">[read]</a>`
                    }
                    <a href="#" onclick="toggleStar(${entry.id}); return false;">[${isStarred ? 'unstar' : 'star'}]</a>
                    ${entry.link ? `<a href="${escapeHtml(entry.link)}" target="_blank" rel="noopener noreferrer">[original]</a>` : ''}
                </div>
            </div>
            `;
        }).join('');
    }

    function updateLoadMoreButton() {
        const btn = document.getElementById('load-more');
        if (entries.length < total) {
            btn.style.display = 'block';
        } else {
            btn.style.display = 'none';
        }
    }

    function updateEntriesCount() {
        document.getElementById('entries-count').textContent = `Showing ${entries.length} of ${total} entries`;
    }

    async function loadMore() {
        currentOffset += limit;
        await loadEntries(false);
    }

    async function markRead(id) {
        try {
            const response = await fetch(`/api/entries/${id}/read`, { method: 'PUT' });
            if (!response.ok) throw new Error('Failed to mark as read');
            const updated = await response.json();
            updateEntryInList(id, updated);
        } catch (err) {
            flash.error(err.message);
        }
    }

    async function markUnread(id) {
        try {
            const response = await fetch(`/api/entries/${id}/unread`, { method: 'PUT' });
            if (!response.ok) throw new Error('Failed to mark as unread');
            const updated = await response.json();
            updateEntryInList(id, updated);
        } catch (err) {
            flash.error(err.message);
        }
    }

    async function toggleStar(id) {
        try {
            const response = await fetch(`/api/entries/${id}/star`, { method: 'PUT' });
            if (!response.ok) throw new Error('Failed to toggle star');
            const updated = await response.json();
            updateEntryInList(id, updated);
        } catch (err) {
            flash.error(err.message);
        }
    }

    function updateEntryInList(id, updated) {
        const idx = entries.findIndex(e => e.id === id);
        if (idx >= 0) {
            entries[idx].read_at = updated.read_at;
            entries[idx].starred_at = updated.starred_at;
            renderEntries();
        }
    }

    async function markAsRead(age) {
        if (!age) return;

        const feedId = document.getElementById('filter-feed').value;
        const categoryId = document.getElementById('filter-category').value;

        const ageLabels = {
            '1': 'older than 1 day',
            '7': 'older than 1 week',
            '30': 'older than 1 month',
            '365': 'older than 1 year',
            'all': 'all'
        };
        const ageLabel = ageLabels[age] || age;

        let scope = '';
        if (feedId) {
            const feedSelect = document.getElementById('filter-feed');
            const feedName = feedSelect.options[feedSelect.selectedIndex].text;
            scope = ` in feed "${feedName}"`;
        } else if (categoryId) {
            const categorySelect = document.getElementById('filter-category');
            const categoryName = categorySelect.options[categorySelect.selectedIndex].text;
            scope = ` in category "${categoryName}"`;
        }

        if (!confirm(`Mark ${ageLabel} entries${scope} as read?`)) {
            return;
        }

        try {
            const body = {};
            if (feedId) {
                body.feed_id = parseInt(feedId);
            } else if (categoryId) {
                body.category_id = parseInt(categoryId);
            }
            if (age !== 'all') {
                body.older_than_days = parseInt(age);
            }

            const response = await fetch('/api/entries/mark-all-read', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (!response.ok) throw new Error('Failed to mark as read');
            const result = await response.json();
            flash.success(`Marked ${result.marked_count} entries as read.`);
            loadEntries();
        } catch (err) {
            flash.error(err.message);
        }
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDate(isoString) {
        const date = new Date(isoString);
        return date.toLocaleDateString();
    }

    function formatDateTime(isoString) {
        const date = new Date(isoString);
        return date.toLocaleString();
    }

    function updateURL() {
        const params = new URLSearchParams();
        const feedId = document.getElementById('filter-feed').value;
        const categoryId = document.getElementById('filter-category').value;
        const unreadOnly = document.getElementById('filter-unread').checked;
        const starredOnly = document.getElementById('filter-starred').checked;
        if (feedId) params.set('feed', feedId);
        if (categoryId) params.set('category', categoryId);
        if (unreadOnly) params.set('unread', '1');
        if (starredOnly) params.set('starred', '1');
        const newURL = params.toString() ? `/entries?${params.toString()}` : '/entries';
        history.replaceState(null, '', newURL);
    }

    function handleFilterChange() {
        updateURL();
        loadEntries();
    }

    document.getElementById('entries-list').addEventListener('click', function(e) {
        if (e.target.matches('[data-feed-id]')) {
            e.preventDefault();
            document.getElementById('filter-feed').value = e.target.dataset.feedId;
            document.getElementById('filter-category').value = e.target.dataset.feedCategoryId;
            handleFilterChange();
        }
        if (e.target.matches('[data-category-id]')) {
            e.preventDefault();
            document.getElementById('filter-category').value = e.target.dataset.categoryId;
            document.getElementById('filter-feed').value = '';
            handleFilterChange();
        }
    });

    // Initialize
    Promise.all([loadCategories(), loadFeeds()]).then(() => {
        // Check URL params
        const urlParams = new URLSearchParams(window.location.search);
        const feedId = urlParams.get('feed');
        const categoryId = urlParams.get('category');
        const unreadOnly = urlParams.get('unread');
        const starredOnly = urlParams.get('starred');
        if (feedId) document.getElementById('filter-feed').value = feedId;
        if (categoryId) document.getElementById('filter-category').value = categoryId;
        if (unreadOnly) document.getElementById('filter-unread').checked = true;
        if (starredOnly) document.getElementById('filter-starred').checked = true;
        loadEntries();
    });
</script>
{% endblock %}
