{% extends "base.html" %}
{% import "macros.html" as macros %}

{% block title %}Home - RDRS{% endblock %}

{% block flash %}{% call macros::flash(flash_messages) %}{% endblock %}

{% block content %}
{% if is_masquerading %}
<div class="flash flash-warning">
  [MASQUERADE] You are viewing as another user. <a href="#" onclick="stopMasquerade(); return false;">[Stop]</a>
</div>
<hr>
{% endif %}
<h1>Home</h1>
<pre>
Username:     {{ username }}
Role:         {{ role }}
Last sign in: {{ sign_in_time }}
</pre>
<hr>
<p>
  → <a href="/change-password">Change Password</a>
</p>
{% if is_admin %}
<p>
  → <a href="/admin">Admin Panel</a>
</p>
{% endif %}
<p>
  → <a href="#" onclick="logout(); return false;">Sign Out</a>
</p>
<script>
  async function logout() {
    try {
      const response = await fetch("/api/session", {
        method: "DELETE",
      });

      if (response.ok) {
        flash.redirect("/login", "info", "You have been logged out.");
      } else {
        flash.error("Logout failed");
        window.location.reload();
      }
    } catch (err) {
      flash.error("An error occurred during logout");
      window.location.reload();
    }
  }

  async function stopMasquerade() {
    try {
      const response = await fetch("/api/admin/unmasquerade", {
        method: "POST",
      });

      if (response.ok) {
        flash.success("Stopped masquerading.");
        window.location.reload();
      } else {
        const error = await response.json();
        flash.error(error.error || "Failed to stop masquerade");
        window.location.reload();
      }
    } catch (err) {
      flash.error("An error occurred");
      window.location.reload();
    }
  }
</script>
{% endblock %}
