{% extends "base.html" %}
{% import "macros.html" as macros %}

{% block title %}Feeds - RDRS{% endblock %}

{% block flash %}{% call macros::flash(flash_messages) %}{% endcall %}{% endblock %}

{% block content %}
{% call macros::nav("feeds", is_admin, is_masquerading, username) %}{% endcall %}

<h1>Feeds</h1>

<div style="display:flex; gap:1rem; flex-wrap:wrap; align-items:center; margin-bottom:1rem;">
    <a href="/api/opml/export" class="btn">[Export OPML]</a>
    <button type="button" onclick="showImportModal()">[Import OPML]</button>
</div>

<hr>

<form id="add-form" onsubmit="addFeed(event)">
    <div class="form-group">
        <label for="url">Feed URL</label>
        <input type="text" id="url" name="url" placeholder="https://example.com/feed.xml or https://example.com" required>
    </div>
    <div class="form-group">
        <label for="category">Category</label>
        <select id="category" name="category" required>
            <option value="">Loading categories...</option>
        </select>
    </div>
    <button type="submit" id="add-btn">[Add Feed]</button>
</form>

<hr>

<div class="filter-bar">
    <div class="form-group form-group-inline">
        <label for="filter-category">Filter by Category</label>
        <select id="filter-category" onchange="handleFilterChange()">
            <option value="">All Categories</option>
        </select>
    </div>
    <div class="form-group form-group-inline">
        <label for="sort-by">Sort by</label>
        <select id="sort-by" onchange="handleFilterChange()">
            <option value="title">Title</option>
            <option value="unread">Unread Count</option>
            <option value="fetched">Last Fetched</option>
            <option value="category">Category</option>
        </select>
    </div>
    <div class="form-group form-group-inline">
        <label>
            <input type="checkbox" id="filter-errors" onchange="handleFilterChange()">
            Show only feeds with errors
        </label>
    </div>
</div>

<table>
    <thead>
        <tr>
            <th>Title</th>
            <th>Category</th>
            <th>Unread</th>
            <th>Last Fetched</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="feeds-table">
        <tr>
            <td colspan="5">Loading...</td>
        </tr>
    </tbody>
</table>

<!-- Import Modal -->
<div id="import-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 class="modal-title">Import OPML</h2>
        <form id="import-form" onsubmit="importOpml(event)">
            <div class="form-group">
                <label for="import-file">Upload .opml file</label>
                <input type="file" id="import-file" accept=".opml,.xml" onchange="loadOpmlFile(this)">
            </div>
            <div class="form-group">
                <label for="import-content">Or paste OPML content</label>
                <textarea id="import-content" rows="10" style="width:100%; font-family:monospace; font-size:0.875rem;" placeholder="<?xml version=&quot;1.0&quot;?>&#10;<opml version=&quot;2.0&quot;>&#10;  ...&#10;</opml>"></textarea>
            </div>
            <div class="modal-actions">
                <button type="submit" id="import-btn">[Import]</button>
                <button type="button" onclick="closeImportModal()">[Cancel]</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Modal -->
<div id="edit-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 class="modal-title">Edit Feed</h2>
        <form id="edit-form" onsubmit="saveFeed(event)">
            <input type="hidden" id="edit-id">
            <div class="form-group">
                <label for="edit-url">Feed URL</label>
                <div style="display:flex; gap:0.5rem;">
                    <input type="text" id="edit-url" name="url" required style="flex:1;">
                    <button type="button" onclick="fetchMetadata()" style="margin:0; white-space:nowrap;">[Fetch]</button>
                </div>
            </div>
            <div class="form-group">
                <label for="edit-title">Title</label>
                <input type="text" id="edit-title" name="title">
            </div>
            <div class="form-group">
                <label for="edit-description">Description</label>
                <input type="text" id="edit-description" name="description">
            </div>
            <div class="form-group">
                <label for="edit-site-url">Site URL</label>
                <input type="text" id="edit-site-url" name="site_url">
            </div>
            <div class="form-group">
                <label for="edit-category">Category</label>
                <select id="edit-category" name="category" required>
                </select>
            </div>
            <details style="margin-top:1rem; border:1px solid #ccc; padding:0.5rem;">
                <summary style="cursor:pointer; font-weight:normal;">HTTP Settings</summary>
                <div style="margin-top:0.5rem;">
                    <div class="form-group">
                        <label for="edit-custom-user-agent">Custom User Agent</label>
                        <input type="text" id="edit-custom-user-agent" name="custom_user_agent" placeholder="Leave empty to use global default">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="edit-http2-disabled" name="http2_disabled">
                            Disable HTTP/2
                        </label>
                        <div style="font-size:0.75rem; color:#666;">Enable this if the feed server has HTTP/2 compatibility issues</div>
                    </div>
                </div>
            </details>
            <div class="modal-actions">
                <button type="submit">[Save]</button>
                <button type="button" onclick="closeEditModal()">[Cancel]</button>
            </div>
        </form>
    </div>
</div>

<script>
    let categories = [];
    let feeds = [];
    let unreadStats = { by_feed: {}, by_category: {} };

    async function loadCategories() {
        try {
            const response = await fetch('/api/categories');
            if (!response.ok) {
                throw new Error('Failed to load categories');
            }
            categories = await response.json();
            updateCategoryDropdowns();
        } catch (err) {
            flash.error(err.message);
        }
    }

    function updateCategoryDropdowns() {
        const addSelect = document.getElementById('category');
        const filterSelect = document.getElementById('filter-category');
        const editSelect = document.getElementById('edit-category');

        if (categories.length === 0) {
            addSelect.innerHTML = '<option value="">No categories available</option>';
        } else {
            addSelect.innerHTML = categories.map(cat =>
                `<option value="${cat.id}">${escapeHtml(cat.name)}</option>`
            ).join('');
        }

        // Filter dropdown keeps "All Categories" option (counts updated after feeds load)
        updateFilterDropdown();

        // Edit dropdown
        editSelect.innerHTML = categories.map(cat =>
            `<option value="${cat.id}">${escapeHtml(cat.name)}</option>`
        ).join('');
    }

    function updateFilterDropdown() {
        const filterSelect = document.getElementById('filter-category');
        const currentValue = filterSelect.value;

        filterSelect.innerHTML = `<option value="">All Categories (${feeds.length})</option>` +
            categories.map(cat => {
                const count = feeds.filter(f => f.category_id === cat.id).length;
                return `<option value="${cat.id}">${escapeHtml(cat.name)} (${count})</option>`;
            }).join('');

        // Restore selection
        filterSelect.value = currentValue;
    }

    async function loadFeeds() {
        try {
            const response = await fetch('/api/feeds');
            if (!response.ok) {
                throw new Error('Failed to load feeds');
            }
            feeds = await response.json();
            updateFilterDropdown();
            renderFeeds();
        } catch (err) {
            document.getElementById('feeds-table').innerHTML =
                '<tr><td colspan="5">[ERROR] Failed to load feeds</td></tr>';
        }
    }

    async function loadUnreadStats() {
        try {
            const response = await fetch('/api/entries/unread-stats');
            if (!response.ok) throw new Error('Failed to load unread stats');
            unreadStats = await response.json();
            renderFeeds();
        } catch (err) {
            console.error(err);
        }
    }

    function updateURL() {
        const params = new URLSearchParams();
        const categoryId = document.getElementById('filter-category').value;
        const sortBy = document.getElementById('sort-by').value;
        const filterErrors = document.getElementById('filter-errors').checked;

        if (categoryId) params.set('category', categoryId);
        if (sortBy && sortBy !== 'title') params.set('sort', sortBy);
        if (filterErrors) params.set('errors', '1');

        const newURL = params.toString() ? `/feeds?${params.toString()}` : '/feeds';
        history.replaceState(null, '', newURL);
    }

    function handleFilterChange() {
        updateURL();
        renderFeeds();
    }

    function renderFeeds() {
        const tbody = document.getElementById('feeds-table');
        const filterCategory = document.getElementById('filter-category').value;
        const filterErrors = document.getElementById('filter-errors').checked;
        const sortBy = document.getElementById('sort-by').value;

        let filteredFeeds = feeds.slice(); // Create a copy
        if (filterCategory) {
            filteredFeeds = filteredFeeds.filter(f => f.category_id == filterCategory);
        }
        if (filterErrors) {
            filteredFeeds = filteredFeeds.filter(f => f.fetch_error !== null);
        }

        // Sort feeds
        filteredFeeds.sort((a, b) => {
            switch (sortBy) {
                case 'unread':
                    const unreadA = unreadStats.by_feed[a.id] || 0;
                    const unreadB = unreadStats.by_feed[b.id] || 0;
                    return unreadB - unreadA; // Descending
                case 'fetched':
                    const dateA = a.fetched_at ? new Date(a.fetched_at) : new Date(0);
                    const dateB = b.fetched_at ? new Date(b.fetched_at) : new Date(0);
                    return dateB - dateA; // Most recent first
                case 'category':
                    const catA = categories.find(c => c.id === a.category_id);
                    const catB = categories.find(c => c.id === b.category_id);
                    const catNameA = catA ? catA.name.toLowerCase() : '';
                    const catNameB = catB ? catB.name.toLowerCase() : '';
                    return catNameA.localeCompare(catNameB);
                case 'title':
                default:
                    const titleA = (a.title || a.url).toLowerCase();
                    const titleB = (b.title || b.url).toLowerCase();
                    return titleA.localeCompare(titleB);
            }
        });

        if (filteredFeeds.length === 0) {
            const msg = filterErrors ? 'No feeds with errors.' : 'No feeds yet.';
            tbody.innerHTML = `<tr><td colspan="5" class="muted">${msg}</td></tr>`;
            return;
        }

        tbody.innerHTML = filteredFeeds.map(feed => {
            const category = categories.find(c => c.id === feed.category_id);
            const categoryName = category ? category.name : 'Unknown';
            const title = feed.title || feed.url;
            const fetchedAt = feed.fetched_at ? formatDate(feed.fetched_at) : '';
            const fetchedAtTitle = feed.fetched_at ? formatDateTime(feed.fetched_at) : '';
            const hasError = feed.fetch_error !== null;
            const iconHtml = feed.has_icon
                ? `<img src="/api/feeds/${feed.id}/icon" alt="" class="feed-icon" onerror="this.style.display='none'">`
                : '';
            const unreadCount = unreadStats.by_feed[feed.id] || 0;

            let rows = `
            <tr id="row-${feed.id}"${hasError ? ' style="border-bottom:none;"' : ''}>
                <td${hasError ? ' style="border-bottom:none;"' : ''}>${iconHtml}<span title="${escapeHtml(feed.url)}">${escapeHtml(title)}</span></td>
                <td${hasError ? ' style="border-bottom:none;"' : ''}>${escapeHtml(categoryName)}</td>
                <td${hasError ? ' style="border-bottom:none;"' : ''}>${unreadCount > 0 ? `<strong>${unreadCount}</strong>` : '0'}</td>
                <td${hasError ? ' style="border-bottom:none;"' : ''}>${fetchedAt ? `<span title="${fetchedAtTitle}">${fetchedAt}</span>` : 'Never'}</td>
                <td class="actions"${hasError ? ' style="border-bottom:none;"' : ''}>
                    <a href="/entries?feed=${feed.id}">[entries]</a>
                    <a href="#" onclick="refreshFeed(${feed.id}); return false;" id="refresh-${feed.id}">[refresh]</a>
                    <a href="#" onclick="editFeed(${feed.id}); return false;">[edit]</a>
                    <a href="#" onclick="deleteFeed(${feed.id}, '${escapeHtml(title).replace(/'/g, "\\'")}'); return false;">[delete]</a>
                </td>
            </tr>`;

            if (hasError) {
                rows += `
            <tr class="error-row">
                <td colspan="5" style="color:red; font-size:0.875rem; padding-top:0;">
                    [Error] ${escapeHtml(feed.fetch_error)}
                </td>
            </tr>`;
            }

            return rows;
        }).join('');
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString();
    }

    function formatDateTime(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleString();
    }

    async function addFeed(event) {
        event.preventDefault();
        const urlInput = document.getElementById('url');
        const categorySelect = document.getElementById('category');
        const addBtn = document.getElementById('add-btn');

        const url = urlInput.value.trim();
        const categoryId = parseInt(categorySelect.value);

        if (!url) {
            flash.error('URL cannot be empty');
            return;
        }

        if (!categoryId) {
            flash.error('Please select a category');
            return;
        }

        addBtn.textContent = '[Adding...]';
        addBtn.disabled = true;

        try {
            const response = await fetch('/api/feeds', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url, category_id: categoryId })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to add feed');
            }

            urlInput.value = '';
            flash.success('Feed added.');
            loadFeeds();
        } catch (err) {
            flash.error(err.message);
        } finally {
            addBtn.textContent = '[Add Feed]';
            addBtn.disabled = false;
        }
    }

    function editFeed(id) {
        const feed = feeds.find(f => f.id === id);
        if (!feed) return;

        document.getElementById('edit-id').value = feed.id;
        document.getElementById('edit-url').value = feed.url;
        document.getElementById('edit-title').value = feed.title || '';
        document.getElementById('edit-description').value = feed.description || '';
        document.getElementById('edit-site-url').value = feed.site_url || '';
        document.getElementById('edit-category').value = feed.category_id;
        document.getElementById('edit-custom-user-agent').value = feed.custom_user_agent || '';
        document.getElementById('edit-http2-disabled').checked = feed.http2_disabled || false;

        document.getElementById('edit-modal').style.display = 'block';
    }

    function closeEditModal() {
        document.getElementById('edit-modal').style.display = 'none';
    }

    function showImportModal() {
        document.getElementById('import-content').value = '';
        document.getElementById('import-file').value = '';
        document.getElementById('import-modal').style.display = 'block';
    }

    function closeImportModal() {
        document.getElementById('import-modal').style.display = 'none';
    }

    async function fetchMetadata() {
        const urlInput = document.getElementById('edit-url');
        const url = urlInput.value.trim();

        if (!url) {
            flash.error('URL cannot be empty');
            return;
        }

        if (!confirm('Fetch metadata from URL? This will overwrite current values.')) {
            return;
        }

        try {
            const response = await fetch('/api/feeds/fetch-metadata', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to fetch metadata');
            }

            const metadata = await response.json();

            document.getElementById('edit-url').value = metadata.feed_url;
            document.getElementById('edit-title').value = metadata.title || '';
            document.getElementById('edit-description').value = metadata.description || '';
            document.getElementById('edit-site-url').value = metadata.site_url || '';

            flash.success('Metadata fetched.');
        } catch (err) {
            flash.error(err.message);
        }
    }

    async function saveFeed(event) {
        event.preventDefault();

        const id = parseInt(document.getElementById('edit-id').value);
        const url = document.getElementById('edit-url').value.trim();
        const title = document.getElementById('edit-title').value.trim() || null;
        const description = document.getElementById('edit-description').value.trim() || null;
        const siteUrl = document.getElementById('edit-site-url').value.trim() || null;
        const categoryId = parseInt(document.getElementById('edit-category').value);
        const customUserAgent = document.getElementById('edit-custom-user-agent').value.trim() || null;
        const http2Disabled = document.getElementById('edit-http2-disabled').checked;

        if (!url) {
            flash.error('URL cannot be empty');
            return;
        }

        try {
            const response = await fetch(`/api/feeds/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    url,
                    title,
                    description,
                    site_url: siteUrl,
                    category_id: categoryId,
                    custom_user_agent: customUserAgent,
                    http2_disabled: http2Disabled
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to update feed');
            }

            closeEditModal();
            flash.success('Feed updated.');
            loadFeeds();
        } catch (err) {
            flash.error(err.message);
        }
    }

    async function deleteFeed(id, title) {
        if (!confirm(`Delete feed "${title}"? This cannot be undone.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/feeds/${id}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to delete feed');
            }

            flash.success(`Feed "${title}" deleted.`);
            loadFeeds();
        } catch (err) {
            flash.error(err.message);
        }
    }

    async function refreshFeed(id) {
        const btn = document.getElementById(`refresh-${id}`);
        const originalText = btn.textContent;
        btn.textContent = '[...]';

        try {
            const response = await fetch(`/api/feeds/${id}/refresh`, {
                method: 'POST'
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to refresh feed');
            }

            const result = await response.json();
            flash.success(`Refreshed: ${result.new_entries} new, ${result.updated_entries} updated.`);
            loadFeeds();
            loadUnreadStats();
        } catch (err) {
            flash.error(err.message);
        } finally {
            btn.textContent = originalText;
        }
    }

    // Close modal when clicking outside
    document.getElementById('edit-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeEditModal();
        }
    });

    document.getElementById('import-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeImportModal();
        }
    });

    function loadOpmlFile(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('import-content').value = e.target.result;
        };
        reader.onerror = function() {
            flash.error('Failed to read file');
        };
        reader.readAsText(file);
    }

    async function importOpml(event) {
        event.preventDefault();

        const content = document.getElementById('import-content').value.trim();
        if (!content) {
            flash.error('Please paste OPML content or upload a file');
            return;
        }

        const importBtn = document.getElementById('import-btn');
        importBtn.textContent = '[Importing...]';
        importBtn.disabled = true;

        try {
            const response = await fetch('/api/opml/import', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to import OPML');
            }

            const result = await response.json();
            closeImportModal();
            flash.success(`Imported: ${result.categories_created} categories, ${result.feeds_created} feeds created, ${result.feeds_skipped} feeds skipped.`);

            // Reload data
            await loadCategories();
            await loadFeeds();
        } catch (err) {
            flash.error(err.message);
        } finally {
            importBtn.textContent = '[Import]';
            importBtn.disabled = false;
        }
    }

    // Initialize
    loadCategories().then(() => {
        // Read filters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const categoryId = urlParams.get('category');
        const sortBy = urlParams.get('sort');
        const filterErrors = urlParams.get('errors');

        if (categoryId) document.getElementById('filter-category').value = categoryId;
        if (sortBy) document.getElementById('sort-by').value = sortBy;
        if (filterErrors) document.getElementById('filter-errors').checked = true;

        loadFeeds();
        loadUnreadStats();
    });
</script>
{% endblock %}
