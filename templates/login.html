{% extends "base.html" %}
{% import "macros.html" as macros %}

{% block title %}Login - RDRS{% endblock %}

{% block flash %}{% call macros::flash(flash_messages) %}{% endblock %}

{% block content %}
<h1>Login</h1>
<div id="error" class="error" style="display: none;"></div>

<div id="passkey-section" style="display: none;">
    <button type="button" id="passkey-login-btn" class="btn-primary" style="width: 100%; margin-bottom: 1rem;">
        [Login with Passkey]
    </button>
    <p class="muted" style="text-align: center; margin-bottom: 1rem;">or use password</p>
</div>

<form id="login-form">
    <div class="form-group">
        <label for="username">Username</label>
        <input type="text" id="username" name="username" required autocomplete="username">
    </div>
    <div class="form-group">
        <label for="password">Password</label>
        <input type="password" id="password" name="password" required autocomplete="current-password">
    </div>
    <button type="submit">[Submit]</button>
</form>
{% if signup_enabled %}
<div class="link">
    â†’ <a href="/register">Create an account</a>
</div>
{% endif %}
<script>
    // Check if WebAuthn is supported
    const isWebAuthnSupported = window.PublicKeyCredential !== undefined;

    if (isWebAuthnSupported) {
        document.getElementById('passkey-section').style.display = 'block';
    }

    // Helper functions for base64url encoding/decoding
    function base64urlToBuffer(base64url) {
        const padding = '='.repeat((4 - base64url.length % 4) % 4);
        const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/') + padding;
        const binary = atob(base64);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
            bytes[i] = binary.charCodeAt(i);
        }
        return bytes.buffer;
    }

    function bufferToBase64url(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        for (let i = 0; i < bytes.length; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }

    // Password login
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const errorDiv = document.getElementById('error');
        errorDiv.style.display = 'none';

        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        try {
            const response = await fetch('/api/session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            if (response.ok) {
                window.location.href = '/';
            } else {
                const data = await response.json();
                errorDiv.textContent = data.error || 'Login failed';
                errorDiv.style.display = 'block';
            }
        } catch (err) {
            errorDiv.textContent = 'An error occurred. Please try again.';
            errorDiv.style.display = 'block';
        }
    });

    // Passkey login
    document.getElementById('passkey-login-btn')?.addEventListener('click', async () => {
        const errorDiv = document.getElementById('error');
        const btn = document.getElementById('passkey-login-btn');
        errorDiv.style.display = 'none';

        try {
            btn.disabled = true;
            btn.textContent = '[Authenticating...]';

            // Start authentication
            const startResponse = await fetch('/api/passkey/auth/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            if (!startResponse.ok) {
                const data = await startResponse.json();
                throw new Error(data.error || 'Failed to start authentication');
            }

            const { options } = await startResponse.json();

            // Prepare credential request options
            const publicKey = {
                ...options.publicKey,
                challenge: base64urlToBuffer(options.publicKey.challenge),
                allowCredentials: options.publicKey.allowCredentials?.map(cred => ({
                    ...cred,
                    id: base64urlToBuffer(cred.id)
                })) || []
            };

            // Get credential from authenticator
            const credential = await navigator.credentials.get({ publicKey });

            // Prepare credential for server
            const credentialForServer = {
                id: credential.id,
                rawId: bufferToBase64url(credential.rawId),
                type: credential.type,
                response: {
                    authenticatorData: bufferToBase64url(credential.response.authenticatorData),
                    clientDataJSON: bufferToBase64url(credential.response.clientDataJSON),
                    signature: bufferToBase64url(credential.response.signature),
                    userHandle: credential.response.userHandle ? bufferToBase64url(credential.response.userHandle) : null
                }
            };

            // Finish authentication
            const finishResponse = await fetch('/api/passkey/auth/finish', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ credential: credentialForServer })
            });

            if (finishResponse.ok) {
                window.location.href = '/';
            } else {
                const data = await finishResponse.json();
                throw new Error(data.error || 'Authentication failed');
            }
        } catch (err) {
            if (err.name === 'NotAllowedError') {
                errorDiv.textContent = 'Authentication was cancelled or timed out.';
            } else {
                errorDiv.textContent = err.message || 'An error occurred. Please try again.';
            }
            errorDiv.style.display = 'block';
        } finally {
            btn.disabled = false;
            btn.textContent = '[Login with Passkey]';
        }
    });
</script>
{% endblock %}
