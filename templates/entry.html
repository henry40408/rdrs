{% extends "base.html" %}
{% import "macros.html" as macros %}

{% block title %}Entry - RDRS{% endblock %}

{% block flash %}{% call macros::flash(flash_messages) %}{% endblock %}

{% block content %}
{% call macros::nav("entries", is_admin, is_masquerading) %}

<div id="entry-container">
    <p class="muted">Loading...</p>
</div>

<script>
    const entryId = {{ entry_id }};

    async function loadEntry() {
        try {
            const response = await fetch(`/api/entries/${entryId}`);
            if (!response.ok) {
                if (response.status === 404) {
                    document.getElementById('entry-container').innerHTML = '<p class="muted">Entry not found.</p>';
                    return;
                }
                throw new Error('Failed to load entry');
            }
            const data = await response.json();
            renderEntry(data);

            // Auto-mark as read
            if (data.read_at === null) {
                await fetch(`/api/entries/${entryId}/read`, { method: 'PUT' });
            }
        } catch (err) {
            document.getElementById('entry-container').innerHTML = '<p class="muted">[ERROR] Failed to load entry</p>';
        }
    }

    function renderEntry(data) {
        const title = data.title || 'Untitled';
        const feedTitle = data.feed_title || data.feed_url;
        const author = data.author || '';
        const date = data.published_at ? new Date(data.published_at).toLocaleString() : '';
        const isStarred = data.starred_at !== null;
        const content = data.sanitized_content || data.summary || '<p class="muted">No content available.</p>';

        document.getElementById('entry-container').innerHTML = `
            <div class="entry-nav">
                <a href="/entries">&larr; Back to Entries</a>
            </div>

            <h1 class="entry-title">${escapeHtml(title)}</h1>

            <div class="entry-meta">
                <span>${escapeHtml(feedTitle)}</span>
                ${author ? ` &middot; <span>${escapeHtml(author)}</span>` : ''}
                ${date ? ` &middot; <span>${date}</span>` : ''}
            </div>

            <div class="entry-actions">
                <button type="button" onclick="toggleStar()" id="star-btn">[${isStarred ? 'Unstar' : 'Star'}]</button>
                <button type="button" onclick="markUnread()">[Mark Unread]</button>
                ${data.link ? `<a href="${escapeHtml(data.link)}" target="_blank" rel="noopener noreferrer" class="btn">[View Original]</a>` : ''}
            </div>

            <hr>

            <article class="entry-content">
                ${content}
            </article>

            <hr>

            <div class="entry-nav entry-nav-bottom">
                <a href="/entries">&larr; Back to Entries</a>
            </div>
        `;
    }

    async function toggleStar() {
        try {
            const response = await fetch(`/api/entries/${entryId}/star`, { method: 'PUT' });
            if (!response.ok) throw new Error('Failed to toggle star');
            const updated = await response.json();
            const btn = document.getElementById('star-btn');
            btn.textContent = updated.starred_at ? '[Unstar]' : '[Star]';
        } catch (err) {
            flash.error(err.message);
        }
    }

    async function markUnread() {
        try {
            const response = await fetch(`/api/entries/${entryId}/unread`, { method: 'PUT' });
            if (!response.ok) throw new Error('Failed to mark as unread');
            flash.success('Marked as unread.');
        } catch (err) {
            flash.error(err.message);
        }
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Initialize
    loadEntry();
</script>

<style>
    .entry-title {
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.3;
        margin-bottom: 0.75rem;
        color: #111;
    }

    .entry-meta {
        color: #666;
        margin-bottom: 1.25rem;
        font-size: 0.9rem;
    }

    .entry-actions {
        margin-bottom: 1.5rem;
    }

    .entry-nav {
        margin-bottom: 1.25rem;
    }

    .entry-nav-bottom {
        margin-bottom: 0;
        margin-top: 1.25rem;
    }

    .entry-content {
        max-width: 720px;
        font-family: Georgia, "Times New Roman", serif;
        font-size: 1.125rem;
        line-height: 1.8;
        color: #222;
    }

    .entry-content p {
        margin-bottom: 1.5em;
        word-break: break-word;
    }

    .entry-content h1,
    .entry-content h2,
    .entry-content h3,
    .entry-content h4,
    .entry-content h5,
    .entry-content h6 {
        font-family: "SF Mono", "Monaco", "Inconsolata", monospace;
        margin-top: 2em;
        margin-bottom: 1em;
        line-height: 1.3;
        color: #111;
    }

    .entry-content h1 { font-size: 1.5rem; }
    .entry-content h2 { font-size: 1.35rem; }
    .entry-content h3 { font-size: 1.2rem; }
    .entry-content h4 { font-size: 1.1rem; }

    .entry-content a {
        color: #0066cc;
        text-decoration: underline;
        text-underline-offset: 2px;
    }

    .entry-content a:hover {
        background: #0066cc;
        color: #fff;
    }

    .entry-content img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 1.5em auto;
        border-radius: 4px;
    }

    .entry-content figure {
        margin: 2em 0;
    }

    .entry-content figcaption {
        text-align: center;
        font-size: 0.9rem;
        color: #666;
        margin-top: 0.5em;
        font-style: italic;
    }

    .entry-content pre {
        overflow-x: auto;
        background: #f8f8f8;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 1rem;
        margin: 1.5em 0;
        font-family: "SF Mono", "Monaco", "Inconsolata", monospace;
        font-size: 0.9rem;
        line-height: 1.5;
    }

    .entry-content code {
        font-family: "SF Mono", "Monaco", "Inconsolata", monospace;
        font-size: 0.9em;
        background: #f0f0f0;
        padding: 0.15em 0.4em;
        border-radius: 3px;
    }

    .entry-content pre code {
        background: none;
        padding: 0;
        font-size: inherit;
    }

    .entry-content blockquote {
        border-left: 4px solid #ddd;
        margin: 1.5em 0;
        padding: 0.5em 0 0.5em 1.5em;
        color: #555;
        font-style: italic;
        background: #fafafa;
    }

    .entry-content blockquote p:last-child {
        margin-bottom: 0;
    }

    .entry-content ul,
    .entry-content ol {
        margin: 1.5em 0;
        padding-left: 2em;
    }

    .entry-content li {
        margin-bottom: 0.5em;
    }

    .entry-content li > ul,
    .entry-content li > ol {
        margin: 0.5em 0;
    }

    .entry-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 1.5em 0;
        font-size: 0.95rem;
    }

    .entry-content th,
    .entry-content td {
        border: 1px solid #ddd;
        padding: 0.75em;
        text-align: left;
    }

    .entry-content th {
        background: #f5f5f5;
        font-weight: bold;
    }

    .entry-content tr:nth-child(even) {
        background: #fafafa;
    }

    .entry-content hr {
        border: none;
        border-top: 1px solid #ddd;
        margin: 2em 0;
    }

    .entry-content strong,
    .entry-content b {
        font-weight: 600;
    }

    .entry-content em,
    .entry-content i {
        font-style: italic;
    }
</style>
{% endblock %}
