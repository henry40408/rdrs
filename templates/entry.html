{% extends "base.html" %}
{% import "macros.html" as macros %}

{% block title %}Entry - RDRS{% endblock %}

{% block flash %}{% call macros::flash(flash_messages) %}{% endblock %}

{% block content %}
{% call macros::nav("entries", is_admin, is_masquerading, username) %}

<div id="entry-container">
    <p class="muted">Loading...</p>
</div>

<script>
    const entryId = {{ entry_id }};
    let entryData = null;
    let neighbors = { prev_id: null, next_id: null };

    async function loadNeighbors() {
        try {
            const response = await fetch(`/api/entries/${entryId}/neighbors`);
            if (response.ok) {
                neighbors = await response.json();
                updateNeighborLinks();
            }
        } catch (err) {
            console.error('Failed to load neighbors:', err);
        }
    }

    function updateNeighborLinks() {
        const prevLinks = [
            document.getElementById('prev-entry-link'),
            document.getElementById('prev-entry-link-bottom')
        ];
        const nextLinks = [
            document.getElementById('next-entry-link'),
            document.getElementById('next-entry-link-bottom')
        ];

        prevLinks.forEach(link => {
            if (link) {
                if (neighbors.prev_id) {
                    link.href = `/entries/${neighbors.prev_id}`;
                    link.classList.remove('disabled');
                } else {
                    link.removeAttribute('href');
                    link.classList.add('disabled');
                }
            }
        });

        nextLinks.forEach(link => {
            if (link) {
                if (neighbors.next_id) {
                    link.href = `/entries/${neighbors.next_id}`;
                    link.classList.remove('disabled');
                } else {
                    link.removeAttribute('href');
                    link.classList.add('disabled');
                }
            }
        });
    }

    function goToPrevEntry() {
        if (neighbors.prev_id) {
            window.location.href = `/entries/${neighbors.prev_id}`;
        }
    }

    function goToNextEntry() {
        if (neighbors.next_id) {
            window.location.href = `/entries/${neighbors.next_id}`;
        }
    }

    async function loadEntry() {
        try {
            const response = await fetch(`/api/entries/${entryId}`);
            if (!response.ok) {
                if (response.status === 404) {
                    document.getElementById('entry-container').innerHTML = '<p class="muted">Entry not found.</p>';
                    return;
                }
                throw new Error('Failed to load entry');
            }
            const data = await response.json();
            entryData = data;
            renderEntry(data);

            // Auto-mark as read
            if (data.read_at === null) {
                await fetch(`/api/entries/${entryId}/read`, { method: 'PUT' });
            }

            // Load neighbors for n/p navigation
            loadNeighbors();
        } catch (err) {
            document.getElementById('entry-container').innerHTML = '<p class="muted">[ERROR] Failed to load entry</p>';
        }
    }

    function renderEntry(data) {
        const title = decodeHtml(data.title) || 'Untitled';
        const feedTitle = decodeHtml(data.feed_title) || data.feed_url;
        const author = decodeHtml(data.author) || '';
        const date = data.published_at ? new Date(data.published_at).toLocaleString() : '';
        const isStarred = data.starred_at !== null;
        const content = data.sanitized_content || data.summary || '<p class="muted">No content available.</p>';
        const feedIconHtml = data.feed_has_icon
            ? `<img src="/api/feeds/${data.feed_id}/icon" alt="" class="feed-icon" onerror="this.style.display='none'">`
            : '';

        document.getElementById('entry-container').innerHTML = `
            <div class="entry-nav">
                <a href="/entries">&larr; Back to Entries</a>
                <span class="entry-nav-sep">&middot;</span>
                <a href="#" id="prev-entry-link" class="disabled">&larr; Previous</a>
                <span class="entry-nav-sep">&middot;</span>
                <a href="#" id="next-entry-link" class="disabled">Next &rarr;</a>
            </div>

            <h1 class="entry-title">${escapeHtml(title)}</h1>

            <div class="entry-meta">
                ${feedIconHtml}<span>${escapeHtml(feedTitle)}</span>
                ${author ? ` &middot; <span>${escapeHtml(author)}</span>` : ''}
                ${date ? ` &middot; <span>${date}</span>` : ''}
            </div>

            <div class="entry-actions">
                <button type="button" onclick="toggleStar()" id="star-btn">[${isStarred ? 'Unstar' : 'Star'}]</button>
                <button type="button" onclick="markUnread()">[Mark Unread]</button>
                ${data.link ? `<button type="button" onclick="fetchFullContent()" id="fetch-content-btn">[Fetch Full Content]</button>` : ''}
                ${data.link ? `<a href="${escapeHtml(data.link)}" target="_blank" rel="noopener noreferrer" class="btn">[View Original]</a>` : ''}
            </div>

            <hr>

            <article class="entry-content">
                ${content}
            </article>

            <hr>

            <div class="entry-nav entry-nav-bottom">
                <a href="#" id="prev-entry-link-bottom" class="disabled">&larr; Previous</a>
                <span class="entry-nav-sep">&middot;</span>
                <a href="/entries">Back to Entries</a>
                <span class="entry-nav-sep">&middot;</span>
                <a href="#" id="next-entry-link-bottom" class="disabled">Next &rarr;</a>
            </div>
        `;
    }

    async function toggleStar() {
        try {
            const response = await fetch(`/api/entries/${entryId}/star`, { method: 'PUT' });
            if (!response.ok) throw new Error('Failed to toggle star');
            const updated = await response.json();
            const btn = document.getElementById('star-btn');
            btn.textContent = updated.starred_at ? '[Unstar]' : '[Star]';
        } catch (err) {
            flash.error(err.message);
        }
    }

    async function markUnread() {
        try {
            const response = await fetch(`/api/entries/${entryId}/unread`, { method: 'PUT' });
            if (!response.ok) throw new Error('Failed to mark as unread');
            flash.success('Marked as unread.');
        } catch (err) {
            flash.error(err.message);
        }
    }

    let showingFullContent = false;
    let originalContent = null;
    let fullContent = null;

    async function fetchFullContent() {
        const btn = document.getElementById('fetch-content-btn');
        btn.textContent = '[Fetching...]';
        btn.disabled = true;

        try {
            const response = await fetch(`/api/entries/${entryId}/fetch-full-content`, {
                method: 'POST'
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to fetch content');
            }

            const data = await response.json();

            // Save original content (first time only)
            if (!originalContent) {
                originalContent = document.querySelector('.entry-content').innerHTML;
            }

            // Save full content for toggling
            fullContent = data.sanitized_content || '<p class="muted">No content extracted.</p>';

            // Display full content
            document.querySelector('.entry-content').innerHTML = fullContent;

            showingFullContent = true;
            btn.style.display = 'none';

            // Add toggle button if not exists
            if (!document.getElementById('toggle-content-btn')) {
                btn.insertAdjacentHTML('afterend',
                    ' <button type="button" onclick="toggleContent()" id="toggle-content-btn">[Show Original]</button>');
            } else {
                document.getElementById('toggle-content-btn').textContent = '[Show Original]';
            }
        } catch (err) {
            flash.error(err.message);
            btn.textContent = '[Fetch Full Content]';
        } finally {
            btn.disabled = false;
        }
    }

    function toggleContent() {
        const contentEl = document.querySelector('.entry-content');
        const toggleBtn = document.getElementById('toggle-content-btn');

        if (showingFullContent) {
            contentEl.innerHTML = originalContent;
            toggleBtn.textContent = '[Show Full Content]';
        } else {
            contentEl.innerHTML = fullContent;
            toggleBtn.textContent = '[Show Original]';
        }
        showingFullContent = !showingFullContent;
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Decode HTML entities (e.g., &#x27; -> ')
    function decodeHtml(html) {
        if (!html) return '';
        const textarea = document.createElement('textarea');
        textarea.innerHTML = html;
        return textarea.value;
    }

    // Keyboard navigation functions
    function scrollContent(direction) {
        const scrollAmount = window.innerHeight * 0.4;
        window.scrollBy({
            top: direction * scrollAmount,
            behavior: 'smooth'
        });
    }

    function goBackToList() {
        window.location.href = '/entries';
    }

    function openOriginalLink() {
        if (entryData && entryData.link) {
            window.open(entryData.link, '_blank', 'noopener,noreferrer');
        }
    }

    // Register keyboard handlers
    window.keyboard.init('entry');
    window.keyboard.registerHandlers({
        handleKey: function(key, shiftKey) {
            switch (key) {
                case 'j':
                    scrollContent(1);
                    return true;
                case 'k':
                    scrollContent(-1);
                    return true;
                case 'n':
                    goToNextEntry();
                    return true;
                case 'p':
                    goToPrevEntry();
                    return true;
                case 'u':
                    markUnread();
                    return true;
                case 's':
                    toggleStar();
                    return true;
                case 'v':
                    openOriginalLink();
                    return true;
                case 'f':
                    // If full content already fetched, toggle between original and full
                    if (fullContent) {
                        toggleContent();
                    } else {
                        // Otherwise fetch full content
                        const fetchBtn = document.getElementById('fetch-content-btn');
                        if (fetchBtn && !fetchBtn.disabled) {
                            fetchFullContent();
                        }
                    }
                    return true;
                case 'Escape':
                case 'q':
                    goBackToList();
                    return true;
            }
            return false;
        }
    });

    // Initialize
    loadEntry();
</script>

<style>
    .entry-title {
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.3;
        margin-bottom: 0.75rem;
        color: #111;
    }

    .entry-meta {
        color: #666;
        margin-bottom: 1.25rem;
        font-size: 0.9rem;
    }

    .entry-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
    }

    .entry-actions button,
    .entry-actions .btn {
        white-space: nowrap;
    }

    .entry-nav {
        margin-bottom: 1.25rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
    }

    .entry-nav-bottom {
        margin-bottom: 0;
        margin-top: 1.25rem;
    }

    .entry-nav-sep {
        color: #999;
    }

    .entry-nav a.disabled {
        color: #ccc;
        pointer-events: none;
        cursor: default;
    }

    .entry-nav a.disabled:hover {
        background: none;
        color: #ccc;
    }

    .entry-content {
        max-width: 720px;
        font-family: Georgia, "Times New Roman", serif;
        font-size: 1.125rem;
        line-height: 1.8;
        color: #222;
    }

    .entry-content p {
        margin-bottom: 1.5em;
        word-break: break-word;
    }

    .entry-content h1,
    .entry-content h2,
    .entry-content h3,
    .entry-content h4,
    .entry-content h5,
    .entry-content h6 {
        font-family: "SF Mono", "Monaco", "Inconsolata", monospace;
        margin-top: 2em;
        margin-bottom: 1em;
        line-height: 1.3;
        color: #111;
    }

    .entry-content h1 { font-size: 1.5rem; }
    .entry-content h2 { font-size: 1.35rem; }
    .entry-content h3 { font-size: 1.2rem; }
    .entry-content h4 { font-size: 1.1rem; }

    .entry-content a {
        color: #0066cc;
        text-decoration: underline;
        text-underline-offset: 2px;
    }

    .entry-content a:hover {
        background: #0066cc;
        color: #fff;
    }

    .entry-content img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 1.5em auto;
        border-radius: 4px;
    }

    .entry-content figure {
        margin: 2em 0;
    }

    .entry-content figcaption {
        text-align: center;
        font-size: 0.9rem;
        color: #666;
        margin-top: 0.5em;
        font-style: italic;
    }

    .entry-content pre {
        overflow-x: auto;
        background: #f8f8f8;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 1rem;
        margin: 1.5em 0;
        font-family: "SF Mono", "Monaco", "Inconsolata", monospace;
        font-size: 0.9rem;
        line-height: 1.5;
    }

    .entry-content code {
        font-family: "SF Mono", "Monaco", "Inconsolata", monospace;
        font-size: 0.9em;
        background: #f0f0f0;
        padding: 0.15em 0.4em;
        border-radius: 3px;
    }

    .entry-content pre code {
        background: none;
        padding: 0;
        font-size: inherit;
    }

    .entry-content blockquote {
        border-left: 4px solid #ddd;
        margin: 1.5em 0;
        padding: 0.5em 0 0.5em 1.5em;
        color: #555;
        font-style: italic;
        background: #fafafa;
    }

    .entry-content blockquote p:last-child {
        margin-bottom: 0;
    }

    .entry-content ul,
    .entry-content ol {
        margin: 1.5em 0;
        padding-left: 2em;
    }

    .entry-content li {
        margin-bottom: 0.5em;
    }

    .entry-content li > ul,
    .entry-content li > ol {
        margin: 0.5em 0;
    }

    .entry-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 1.5em 0;
        font-size: 0.95rem;
    }

    .entry-content th,
    .entry-content td {
        border: 1px solid #ddd;
        padding: 0.75em;
        text-align: left;
    }

    .entry-content th {
        background: #f5f5f5;
        font-weight: bold;
    }

    .entry-content tr:nth-child(even) {
        background: #fafafa;
    }

    .entry-content hr {
        border: none;
        border-top: 1px solid #ddd;
        margin: 2em 0;
    }

    .entry-content strong,
    .entry-content b {
        font-weight: 600;
    }

    .entry-content em,
    .entry-content i {
        font-style: italic;
    }
</style>
{% endblock %}
